/**
 * Генерирует BUSINESS_PLAN.docx из структурированного содержимого.
 * Запуск: node scripts/generate-business-plan-docx.js
 * Требует: npm install docx (в корне проекта)
 */
const fs = require('fs');
const path = require('path');
const {
  Document,
  Packer,
  Paragraph,
  TextRun,
  Table,
  TableRow,
  TableCell,
  HeadingLevel,
  WidthType,
  BorderStyle,
  AlignmentType,
  ShadingType,
  convertInchesToTwip,
} = require('docx');

function heading1(text) {
  return new Paragraph({
    text,
    heading: HeadingLevel.TITLE,
    spacing: { after: 200 },
  });
}

function heading2(text) {
  return new Paragraph({
    text,
    heading: HeadingLevel.HEADING_1,
    spacing: { before: 280, after: 120 },
  });
}

function heading3(text) {
  return new Paragraph({
    text,
    heading: HeadingLevel.HEADING_2,
    spacing: { before: 200, after: 100 },
  });
}

function p(text, bold = false) {
  return new Paragraph({
    children: [new TextRun({ text, bold })],
    spacing: { after: 100 },
  });
}

function pMulti(children) {
  return new Paragraph({
    children: children.map((c) => (typeof c === 'string' ? new TextRun({ text: c }) : c)),
    spacing: { after: 100 },
  });
}

function bullet(text) {
  return new Paragraph({
    text,
    bullet: { level: 0 },
    spacing: { after: 60 },
  });
}

function tableRow(cells, header = false) {
  return new TableRow({
    children: cells.map(
      (text) =>
        new TableCell({
          children: [
            new Paragraph({
              children: [new TextRun({ text, bold: header })],
              alignment: header ? AlignmentType.CENTER : undefined,
            }),
          ],
          shading: header ? { type: ShadingType.CLEAR, fill: 'E0E0E0' } : undefined,
        })
    ),
  });
}

const doc = new Document({
  sections: [
    {
      properties: {
        page: {
          margin: {
            top: convertInchesToTwip(0.8),
            right: convertInchesToTwip(0.8),
            bottom: convertInchesToTwip(0.8),
            left: convertInchesToTwip(0.8),
          },
        },
      },
      children: [
        heading1('Бизнес-план: ArendaRate'),
        p('Версия документа: 1.0', false),
        p('Дата: 2025 г.', false),
        new Paragraph({ text: '', spacing: { after: 200 } }),

        heading2('1. Резюме проекта'),
        p('ArendaRate — онлайн-платформа отзывов об аренде жилья с интерактивной картой. Сервис даёт арендаторам возможность честно оценивать съёмное жильё по объективным критериям (состояние, чистота, безопасность, соседи, инфраструктура, транспорт), а арендодателям — отвечать на отзывы и формировать доверие. Отличительная черта — прозрачность: отзывы привязаны к конкретным адресам и квартирам, что отсутствует у крупных досок объявлений (Авито, Циан, Юла).'),
        p('Миссия: честная аренда через открытые отзывы и рейтинги.'),
        p('Девиз: «ArendaRate — твой опыт, это чья-то безопасность. Честная аренда начинается здесь».'),
        p('Статус: стартап на стадии запуска. Текущая аудитория — 0 пользователей. Продукт разработан и развёрнут, ведётся подготовка к привлечению пользователей и монетизации.'),

        heading2('2. Команда'),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          borders: {
            top: { style: BorderStyle.SINGLE, size: 1 },
            bottom: { style: BorderStyle.SINGLE, size: 1 },
            left: { style: BorderStyle.SINGLE, size: 1 },
            right: { style: BorderStyle.SINGLE, size: 1 },
          },
          rows: [
            tableRow(['Роль', 'ФИО', 'Вклад'], true),
            tableRow(['Идейный вдохновитель, куратор', 'Сапронов Павел Анатольевич', 'Идея продукта, видение, постановка задач, контроль развития']),
            tableRow(['Full-Stack разработчик', 'Лунев Данила Игоревич', 'Разработка платформы (фронтенд, бэкенд, инфраструктура)']),
          ],
        }),
        new Paragraph({ spacing: { after: 120 } }),
        p('Оба основателя являются создателями проекта; уход ключевых лиц не планируется и рассматривается как недопустимый с точки зрения преемственности продукта.'),
        p('Дефицит команды:', true),
        bullet('Маркетологи (привлечение арендаторов и арендодателей, продвижение бренда)'),
        bullet('Дизайнеры (UX/UI, визуальная идентичность, адаптация под новые рынки)'),
        p('Привлечение инвестиций направлено в том числе на закрытие этих позиций.'),

        heading2('3. Продукт и ценность'),
        heading3('3.1 Что делает платформа'),
        bullet('Арендаторы регистрируются, оставляют отзывы по адресам/квартирам с оценками по критериям (техсостояние, чистота, безопасность, комфорт, честность арендодателя, цена/качество), прикладывают фото. Отзывы проходят модерацию.'),
        bullet('Арендодатели регистрируются, привязывают объекты к адресам на карте, покупают пакеты «ответов на отзывы» и отвечают на отзывы арендаторов, формируя репутацию.'),
        bullet('Карта — интерактивная карта с метками адресов и агрегированной информацией по отзывам, поиск по городу/улице.'),
        bullet('Маркетологи (партнёры) продвигают подписку арендодателей по промокодам и получают процент от платежей.'),
        heading3('3.2 Монетизация (текущая и планируемая)'),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          borders: {
            top: { style: BorderStyle.SINGLE, size: 1 },
            bottom: { style: BorderStyle.SINGLE, size: 1 },
            left: { style: BorderStyle.SINGLE, size: 1 },
            right: { style: BorderStyle.SINGLE, size: 1 },
          },
          rows: [
            tableRow(['Источник', 'Описание', 'Статус'], true),
            tableRow(['Подписка арендодателей', 'Пакеты ответов: 1 — 100 ₽, 3 — 340 ₽, 5 — 450 ₽, 10 — 900 ₽. Промокоды и партнёрская программа.', 'Реализовано, приём платежей — ЮKassa (подключение в процессе)']),
            tableRow(['Реклама на сайте', 'Баннеры, нативная реклама для риелторов, застройщиков, сервисов для аренды', 'В планах']),
            tableRow(['Расширенные услуги для арендодателей', 'Доп. размещение, выделение объявлений, аналитика', 'В перспективе']),
          ],
        }),
        new Paragraph({ spacing: { after: 120 } }),
        heading3('3.3 Отличие от конкурентов'),
        bullet('Авито, Циан, Юла — доски объявлений с акцентом на сделки. Отзывов по конкретным адресам и квартирам с прозрачной модерацией и рейтингами нет.'),
        bullet('ArendaRate — отдельный продукт про «опыт проживания» и «репутацию места», а не про размещение объявлений. Новая категория: «рейтинг арендного жилья по отзывам».'),
        p('Ценность для пользователей: снижение рисков при выборе жилья и формирование доверия через открытые отзывы.'),

        heading2('4. Рынок и география'),
        bullet('Текущий фокус: РФ (русскоязычная версия, платёжная система ЮKassa для СНГ).'),
        bullet('Планы: выход на международный рынок — локализация продукта, адаптация под локальные платежи и правовые требования.'),
        p('Целевая аудитория: арендаторы (ищущие жильё и желающие опираться на отзывы) и арендодатели (заинтересованные в репутации и обратной связи).'),

        heading2('5. Юридическая форма и платежи'),
        bullet('Текущий статус: деятельность ведётся от имени самозанятого (реквизиты на сайте в разделе «Контакты и реквизиты»).'),
        bullet('Планы: переход на юридическое лицо (ИП или ООО) для масштабирования, работы с рекламой и международными платёжными системами.'),
        bullet('Платежи: приём оплаты за подписку — через ЮKassa (рынок СНГ). Рассматривается подключение международных платёжных систем при выходе за пределы СНГ.'),
        bullet('Персональные данные: политика минимального сбора данных; обработка в соответствии с пользовательским соглашением и законодательством.'),

        heading2('6. Финансы'),
        heading3('6.1 Текущие расходы'),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          borders: {
            top: { style: BorderStyle.SINGLE, size: 1 },
            bottom: { style: BorderStyle.SINGLE, size: 1 },
            left: { style: BorderStyle.SINGLE, size: 1 },
            right: { style: BorderStyle.SINGLE, size: 1 },
          },
          rows: [
            tableRow(['Статья', 'Сумма (руб/мес)', 'Комментарий'], true),
            tableRow(['Хостинг / инфраструктура', '799', 'Текущая конфигурация; при росте нагрузки планируется увеличение мощности и затрат']),
          ],
        }),
        new Paragraph({ spacing: { after: 120 } }),
        heading3('6.2 Выручка'),
        p('На момент составления документа выручка отсутствует (0 пользователей, монетизация готовится к запуску).'),
        heading3('6.3 Запрашиваемые инвестиции'),
        p('Сумма не фиксирована. Направления использования средств:', true),
        bullet('Маркетинг — найм команды маркетологов, привлечение арендаторов и арендодателей, продвижение бренда.'),
        bullet('Дизайн — найм дизайнера (UX/UI, визуальная идентичность, адаптация под новые рынки).'),
        bullet('Инфраструктура — запас по финансам для масштабирования серверов и повышения надёжности при росте трафика.'),
        bullet('Локализация и международная экспансия — переводы, адаптация продукта и платежей под зарубежные рынки.'),
        p('Конкретный объём раунда и долевое участие обсуждаются с инвесторами отдельно.'),

        heading2('7. Риски и митигация'),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          borders: {
            top: { style: BorderStyle.SINGLE, size: 1 },
            bottom: { style: BorderStyle.SINGLE, size: 1 },
            left: { style: BorderStyle.SINGLE, size: 1 },
            right: { style: BorderStyle.SINGLE, size: 1 },
          },
          rows: [
            tableRow(['Риск', 'Митигация'], true),
            tableRow(['Низкий приток пользователей', 'Привлечение маркетологов за счёт инвестиций; фокус на нише «отзывы об аренде» и отстройка от досок объявлений']),
            tableRow(['Рост затрат на инфраструктуру', 'Заложенный в запрос инвестиций резерв на сервера; масштабирование по мере роста выручки']),
            tableRow(['Конкуренция со стороны крупных игроков', 'Удержание фокуса на прозрачности отзывов и рейтингах по адресам; быстрая экспансия в регионы и ниши']),
            tableRow(['Юридические и платёжные ограничения при выходе за рубеж', 'Поэтапная локализация, консультации с юристами и подключение локальных платёжных решений']),
          ],
        }),
        new Paragraph({ spacing: { after: 120 } }),

        heading2('8. Дорожная карта (кратко)'),
        bullet('Запуск монетизации в РФ — подключение ЮKassa, стабилизация подписной модели и партнёрской программы.'),
        bullet('Привлечение первых пользователей — маркетинг и дизайн за счёт инвестиций.'),
        bullet('Рост базы отзывов и арендодателей — увеличение ценности платформы и LTV.'),
        bullet('Внедрение рекламы — дополнительный поток выручки.'),
        bullet('Переход на ЮЛ — оформление юридического лица для масштабирования.'),
        bullet('Локализация и международная экспансия — выход на выбранные зарубежные рынки.'),

        heading2('9. Контакты'),
        bullet('Сайт: ArendaRate (https://arendrate.ru) или актуальный домен'),
        bullet('Email: ArendaRate@yandex.ru'),
        bullet('Telegram: t.me/ArendaRateTS (техподдержка)'),
        p('Для обсуждения инвестиций и партнёрства — по запросу через указанные контакты.'),

        new Paragraph({ spacing: { before: 300 } }),
        p('Документ подготовлен для презентации проекта потенциальным инвесторам. Содержит конфиденциальную информацию; распространение — по согласованию с основателями.', false),
      ],
    },
  ],
});

const outPath = path.join(__dirname, '..', 'BUSINESS_PLAN.docx');
Packer.toBuffer(doc).then((buffer) => {
  fs.writeFileSync(outPath, buffer);
  console.log('Создан файл: BUSINESS_PLAN.docx');
}).catch((err) => {
  console.error('Ошибка:', err);
  process.exit(1);
});
