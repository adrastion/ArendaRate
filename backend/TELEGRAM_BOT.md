# Telegram-бот для модерации

Бот уведомляет модераторов о новых отзывах и позволяет одобрять/отклонять их из Telegram. Доступ только у пользователей из `TELEGRAM_ALLOWED_USER_IDS`.

## Переменные окружения

В `.env` задайте:

- **TELEGRAM_BOT_TOKEN** — токен от @BotFather.
- **TELEGRAM_ALLOWED_USER_IDS** — ID пользователей Telegram через запятую (только они могут использовать бота и получать уведомления).
- **TELEGRAM_NOTIFY_CHAT_IDS** — (необязательно) куда слать уведомления о новых отзывах. Если пусто, используются `TELEGRAM_ALLOWED_USER_IDS`.

## Регистрация вебхука

Чтобы Telegram присылал обновления (нажатия кнопок, команды) на ваш сервер:

1. Сервер должен быть доступен по HTTPS.
2. Вызовите метод Telegram API:

```bash
curl -X POST "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url":"https://ваш-домен.ru/api/telegram-webhook"}'
```

Замените `<ВАШ_ТОКЕН>` и `https://ваш-домен.ru` на свои значения.

## Команды бота

- **/start**, **/users**, **/stats** — показать статистику: число зарегистрированных пользователей, отзывов на карте и на модерации.
- **/server**, **/load** — текущая нагрузка на сервер: load average, CPU, память, диск, uptime (для оценки необходимости апгрейда).

## Ежедневная сводка

Каждый день в **19:00 серверного времени** бот отправляет в те же чаты (куда приходят уведомления о новых отзывах):

- **Итоги за 24 часа:** новых пользователей, новых отзывов, одобрено, отклонено.
- **Нагрузка на сервер:** снимок в момент отправки (load average, CPU, память, диск, uptime).

Время зависит от часового пояса сервера. Чтобы использовать, например, московское время, задайте на сервере `TZ=Europe/Moscow` перед запуском процесса.

## Алерты по нагрузке сервера

Каждые **5 минут** бот проверяет нагрузку (CPU, ОЗУ, load average, диск). Если какой-то порог превышен, в те же чаты отправляется сообщение вида: «Высокая нагрузка на сервер: CPU 95%, … Проверьте сервер.»

Пороги и интервал повторных алертов задаются в `.env` (по умолчанию — разумные значения для небольшого VPS):

| Переменная | По умолчанию | Описание |
|------------|--------------|----------|
| ALERT_CPU_PERCENT | 90 | Алерт, если CPU ≥ этого % |
| ALERT_MEM_PERCENT | 90 | Алерт, если занято ОЗУ ≥ этого % |
| ALERT_LOAD_MAX | 2 | Алерт, если load average ≥ этого значения |
| ALERT_DISK_PERCENT | 90 | Алерт, если занято места на диске ≥ этого % |
| ALERT_COOLDOWN_MINUTES | 60 | Не отправлять повторный алерт чаще чем раз в N минут |

Для сервера 2 ядра / 4 ГБ ОЗУ можно поставить, например: 85 / 85 / 2 / 85 и cooldown 60.

## Поведение

- При создании отзыва на сайте всем из списка уведомлений уходит сообщение с адресом, рейтингом, комментарием и кнопками «Одобрить» / «Отклонить».
- **Одобрить** — отзыв сразу переводится в статус одобрен.
- **Отклонить** — бот просит прислать причину следующим сообщением; после текста отзыв отклоняется с этой причиной.
- В логах модерации используется первый пользователь с ролью ADMIN или MODERATOR в БД (как «исполнитель» действия из бота).
