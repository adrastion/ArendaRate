# Реализация функционала арендодателя и связанных фич

## Выполнено

### 1. Схема БД (Prisma)
- Добавлены роли: `LANDLORD`, `MARKETER`
- `User`: `isBlocked`, `passwordChangeRequired`, `linkedLandlordId` (связь арендатор↔арендодатель)
- `LandlordApartment` — квартиры арендодателя
- `LandlordSubscription` — подписка (остаток ответов)
- `LandlordSubscriptionPurchase` — история покупок
- `PromoCode`, `MarketerProfile` — промокоды и маркетологи
- `ReviewResponse` — ответ арендодателя на отзыв
- `ReviewVote` — лайк/дизлайк
- `ReviewReport` — жалобы
- `SystemSettings` — настройки (вкл/выкл промокода)
- Уникальность: один отзыв арендатора на одну квартиру

### 2. Регистрация
- Выбор: Арендатор / Арендодатель
- Для арендодателя: кнопка «Подписаться»
- Модалка 1: преимущества подписки (3 пункта) + «Перейти к оформлению»
- Модалка 2: выбор плана (1/3/5/10 ответов, цены 100/340/450/900 ₽)
- Регистрация арендодателя с подпиской (без реальной оплаты)
- OAuth (Яндекс, VK): при выборе «Арендодатель» или «Войти как арендодатель» после входа открывается оформление подписки (см. п. 10)

### 3. Миграция
- `prisma/migrations/20260206120000_add_promo_marketer_system_settings/migration.sql`

**Перед запуском:** `cd backend && npx prisma migrate deploy`

---

## В работе / TODO

### 4. Профиль арендодателя ✅
- [x] Счётчик оставшихся ответов
- [x] Указание адреса сдаваемого жилья (добавить в «мои сдаваемые» со страницы квартиры/карты)
- [x] Список отвеченных и неотвеченных отзывов

### 5. Отзывы ✅
- [x] Кнопки: Лайк, Дизлайк, Пожаловаться, Ответить (только для арендодателя своей квартиры) — компонент `ReviewActions` на странице квартиры и адреса
- [x] Арендодатель не может оставлять отзывы (кнопка «Добавить отзыв» скрыта для LANDLORD на карте и странице адреса)
- [x] Ответ арендодателя и `landlordResponse` в API квартиры и адреса
- [x] Один отзыв арендатора на одну квартиру (схема + бэкенд)

### 6. Переключение аккаунтов ✅
- [x] Переключение арендатор ↔ арендодатель: POST /auth/switch-to-linked, блок в профиле
- [x] Для арендатора без привязки: модалка подписки + пароль → POST /auth/link-landlord
- [x] Запрет отзыва на адреса привязанного арендодателя (уже в бэкенде)

### 7. Промокоды ✅
- [x] Поле ввода промокода при оформлении подписки (модалка + регистрация + привязка арендодателя)
- [x] Валидация и применение скидки (promoService: PERCENT/FIXED, maxUses, marketerId в покупке)

### 8. Админ-панель ✅
- [x] Вход через ту же страницу авторизации (роль ADMIN)
- [x] Блокировка пользователя, установка кол-ва ответов подписки
- [x] Создать промокод (код, тип, значение, maxUses, marketerId)
- [x] Создать маркетолога (email, процент, одноразовый пароль)
- [x] Статистика покупок и маркетологов
- [x] Вкл/выкл поля промокода (SystemSettings promo_code_field_enabled)

### 9. Кабинет маркетолога ✅
- [x] Вход через ту же страницу авторизации (роль MARKETER)
- [x] Смена пароля при первом входе (passwordChangeRequired + сброс после смены)
- [x] Просмотр промокодов, процента, статистики применения и заработка

### 10. OAuth для арендодателя ✅
- [x] Передача `userType=landlord`: в сессии (Яндекс/VK redirect) и в body (VK One Tap POST /auth/vk/token)
- [x] После callback: редирект на `/auth/complete-landlord` с модалкой (преимущества → план + пароль + промокод) и вызов `linkLandlordAccount`
- [x] На странице регистрации при выборе «Арендодатель» ссылки OAuth с `?userType=landlord`; на странице входа — чекбокс «Войти как арендодатель»
